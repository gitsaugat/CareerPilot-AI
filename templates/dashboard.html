{% extends "layouts/base_app.html" %}

{% block title %}Candidate Dashboard | CareerPilot AI{% endblock %}

{% block content %}
<div class="container-fluid px-0">
  <!-- Hero Section -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-end">
        <div>
          <h6 class="text-uppercase text-secondary fw-bold small tracking-wide mb-2">Overview</h6>
          <h1 class="display-5 fw-bold text-dark mb-1">Welcome back, {{ session['username'] }}</h1>
          <p class="text-muted mb-0 lead">Here's what's happening with your job search today.</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary btn-lg shadow-sm d-flex align-items-center gap-2" data-bs-toggle="modal"
            data-bs-target="#uploadModal">
            <i class="bi bi-cloud-arrow-up-fill"></i>
            <span>Upload Resume</span>
          </button>
          <a href="{{ url_for('jobs.jobs_create') }}"
            class="btn btn-outline-dark btn-lg shadow-sm d-flex align-items-center gap-2">
            <i class="bi bi-plus-lg"></i>
            <span>Track Job</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="row g-4 mb-5">
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100 py-3"
        style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="bg-white bg-opacity-25 rounded-circle p-2 d-flex align-items-center justify-content-center"
              style="width: 40px; height: 40px;">
              <i class="bi bi-briefcase-fill fs-5 text-white"></i>
            </div>
            <span class="badge bg-white bg-opacity-25 text-white border-0">Total</span>
          </div>
          <h2 class="display-5 fw-bold mb-0">{{ total_applications }}</h2>
          <p class="mb-0 text-white-50 small">Active Applications</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100 py-3">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="bg-warning bg-opacity-10 rounded-circle p-2 d-flex align-items-center justify-content-center"
              style="width: 40px; height: 40px;">
              <i class="bi bi-chat-square-text-fill fs-5 text-warning"></i>
            </div>
            <span class="badge bg-warning bg-opacity-10 text-warning border-0">Action</span>
          </div>
          <h2 class="display-5 fw-bold mb-0 text-dark">{{ interviews_count }}</h2>
          <p class="mb-0 text-secondary small">Interviews Scheduled</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100 py-3">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="bg-success bg-opacity-10 rounded-circle p-2 d-flex align-items-center justify-content-center"
              style="width: 40px; height: 40px;">
              <i class="bi bi-file-earmark-check-fill fs-5 text-success"></i>
            </div>
            <span class="badge bg-success bg-opacity-10 text-success border-0">Optimized</span>
          </div>
          <h2 class="display-5 fw-bold mb-0 text-dark">{{ resumes|length }}</h2>
          <p class="mb-0 text-secondary small">Resume Versions</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Main Content: Active Applications -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center sticky-top">
          <h5 class="fw-bold mb-0">Recent Activity</h5>
          <a href="{{ url_for('jobs.jobs_create') }}" class="btn btn-sm btn-primary rounded-pill">
            <i class="bi bi-plus-lg me-1"></i> Add
          </a>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" style="min-width: 600px;">
              <thead class="bg-light">
                <tr>
                  <th class="ps-4 text-secondary small text-uppercase fw-bold">Role & Company</th>
                  <th class="text-secondary small text-uppercase fw-bold">Date</th>
                  <th class="text-end pe-4 text-secondary small text-uppercase fw-bold">Status</th>
                </tr>
              </thead>
              <tbody>
                {% for job in recent_jobs %}
                <tr>
                  <td class="ps-4">
                    <div class="d-flex align-items-center gap-3">
                      <div
                        class="avatar bg-light text-secondary rounded-3 d-flex align-items-center justify-content-center fw-bold border"
                        style="width: 48px; height: 48px;">
                        <i class="bi bi-building"></i>
                      </div>
                      <div>
                        <h6 class="mb-0 text-dark fw-bold">{{ job.title }}</h6>
                        <small class="text-muted">{{ job.company or 'Unknown Company' }}</small>
                      </div>
                    </div>
                  </td>
                  <td class="text-muted">{{ job.created_at.strftime('%b %d') }}</td>
                  <td class="text-end pe-4">
                    {% set badge_class = 'bg-secondary' %}
                    {% if job.status == 'Applied' %}
                    {% set badge_class = 'bg-primary' %}
                    {% elif job.status == 'Interviewing' %}
                    {% set badge_class = 'bg-warning text-dark' %}
                    {% elif job.status == 'Offer' %}
                    {% set badge_class = 'bg-success' %}
                    {% elif job.status == 'Rejected' %}
                    {% set badge_class = 'bg-danger' %}
                    {% endif %}
                    <span
                      class="badge {{ badge_class }} bg-opacity-10 text-{{ badge_class | replace('bg-', '') if 'text-dark' not in badge_class else 'dark' }} border border-{{ badge_class | replace('bg-', '') if 'text-dark' not in badge_class else 'warning' }} border-opacity-25 px-2 py-1">
                      {{ job.status }}
                    </span>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="3" class="text-center py-5 text-muted">
                    <div class="mb-3">
                      <i class="bi bi-briefcase display-4 opacity-25"></i>
                    </div>
                    <h6 class="fw-bold text-dark">No Recent Activity</h6>
                    <p class="small mb-0">Track your first job application to get started.</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        <div class="card-footer bg-white border-top text-center py-3">
          <a href="{{ url_for('jobs.jobs_list') }}" class="text-decoration-none fw-bold small">View All Applications</a>
        </div>
      </div>
    </div>

    <!-- Right Side: Sidebar -->
    <div class="col-lg-4">
      <!-- Resume Manager -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
          <h6 class="fw-bold mb-0">My Resumes</h6>
          <small class="text-muted">{{ resumes|length }} versions</small>
        </div>
        <div class="card-body p-0">
          <ul class="list-group list-group-flush">
            {% for resume in resumes[:5] %}
            <li class="list-group-item px-3 py-3 border-bottom-0 d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center gap-3" style="min-width: 0;">
                <div class="bg-danger bg-opacity-10 text-danger rounded p-2 flex-shrink-0">
                  <i class="bi bi-file-earmark-pdf-fill"></i>
                </div>
                <div class="text-truncate">
                  <h6 class="mb-0 small fw-bold text-truncate">{{ resume.name }}</h6>
                  <small class="text-muted">{{ resume.created_at.strftime('%b %d') }}</small>
                </div>
              </div>
              <div class="dropdown">
                <button class="btn btn-sm btn-link text-muted p-0" type="button" data-bs-toggle="dropdown">
                  <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
                  <li><a class="dropdown-item" href="{{ url_for('tools.compare_resume', resume_id=resume.id) }}"><i
                        class="bi bi-lightning-fill me-2"></i>Analyze Match</a></li>
                  <li><a class="dropdown-item" href="{{ url_for('resumes.download_resume', resume_id=resume.id) }}"><i
                        class="bi bi-download me-2"></i>Download</a></li>
                  <li>
                    <hr class="dropdown-divider">
                  </li>
                  <li>
                    <form action="{{ url_for('resumes.delete_resume', resume_id=resume.id) }}" method="post"
                      class="d-inline">
                      <button type="submit" class="dropdown-item text-danger"><i
                          class="bi bi-trash me-2"></i>Delete</button>
                    </form>
                  </li>
                </ul>
              </div>
            </li>
            {% else %}
            <li class="list-group-item text-center text-muted py-4">
              <small>No resumes uploaded yet.</small>
            </li>
            {% endfor %}
          </ul>
        </div>
        <div class="card-footer bg-light border-top p-2 text-center">
          <button class="btn btn-sm btn-link text-decoration-none" data-bs-toggle="modal"
            data-bs-target="#uploadModal">+ Upload New Version</button>
        </div>
      </div>

      <!-- AI Tools -->
      <div class="card border-0 shadow-sm" style="background: #1e293b; color: white;">
        <div class="card-body p-4">
          <div class="d-flex align-items-center gap-3 mb-4">
            <div class="bg-white bg-opacity-10 rounded-circle p-2">
              <i class="bi bi-stars text-warning"></i>
            </div>
            <div>
              <h5 class="fw-bold mb-0">AI Career Coach</h5>
              <small class="text-white-50">Boost your chances</small>
            </div>
          </div>
          <div class="d-grid gap-3">
            <a href="{{ url_for('tools.cover_letter') }}"
              class="btn btn-light btn-sm text-start d-flex justify-content-between align-items-center">
              <span><i class="bi bi-pen me-2"></i>Write Cover Letter</span>
              <i class="bi bi-chevron-right small text-muted"></i>
            </a>
            <a href="{{ url_for('tools.interview_prep') }}"
              class="btn btn-light btn-sm text-start d-flex justify-content-between align-items-center">
              <span><i class="bi bi-mic me-2"></i>Interview Prep</span>
              <i class="bi bi-chevron-right small text-muted"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-bottom-0 pb-0">
        <h5 class="modal-title fw-bold">Upload Resume</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-4">
        <form method="post" action="{{ url_for('resumes.upload_resume') }}" enctype="multipart/form-data">
          <div class="mb-4">
            <label for="name" class="form-label fw-bold small text-uppercase text-secondary">Label / Version
              Name</label>
            <input type="text" class="form-control" id="name" name="name" placeholder="e.g. Software Engineer - Google">
          </div>
          <div class="mb-4">
            <label class="form-label fw-bold small text-uppercase text-secondary">File Upload</label>
            <div class="border-2 border-dashed rounded-3 p-5 text-center bg-light"
              style="cursor: pointer; border-color: #cbd5e1;" onclick="document.getElementById('resume_file').click()">
              <input type="file" class="d-none" id="resume_file" name="resume_file" accept=".pdf,.doc,.docx" required>
              <i class="bi bi-cloud-arrow-up display-4 text-primary mb-3 d-block"></i>
              <p class="mb-1 fw-bold">Click to upload or drag & drop</p>
              <small class="text-muted">PDF, DOCX up to 10MB</small>
            </div>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary py-2 fw-bold">Upload & Analyze</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}