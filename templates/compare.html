{% extends "layouts/base_app.html" %}

{% block title %}Compare Resume{% endblock %}

{% block content %}
<!-- Toolbar / Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <a href="{{ url_for('dashboard') }}" class="text-decoration-none text-muted mb-2 d-inline-block">
      &larr; Back to Dashboard
    </a>
    <h2 class="h3 fw-bold text-dark mb-0">Analyze Candidate Match</h2>
  </div>
</div>

<!-- Top Row: Inputs -->
<div class="row g-4 mb-4">
  <!-- Left Column: Job Description Input -->
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0 fw-bold">Job Description</h5>
        <!-- Load Job Dropdown -->
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
            aria-expanded="false">
            Load Saved Job
          </button>
          <ul class="dropdown-menu dropdown-menu-end" style="max-height: 300px; overflow-y: auto;">
            {% if jobs %}
            {% for job in jobs %}
            <li><a class="dropdown-item load-job-btn" href="#" data-description="{{ job.description | e }}">{{ job.title
                }}</a></li>
            {% endfor %}
            {% else %}
            <li><span class="dropdown-item text-muted">No saved jobs</span></li>
            {% endif %}
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item text-primary" href="{{ url_for('jobs_create') }}">Create New Job</a></li>
          </ul>
        </div>
      </div>
      <div class="card-body d-flex flex-column" style="height: 600px;">
        <p class="text-muted small mb-3">
          Select a saved job or paste the description below.
        </p>
        <form method="post" id="compare-form" class="d-flex flex-column flex-grow-1" style="min-height: 0;">
          <input type="hidden" name="job_description" id="job_description_input" />

          <div class="flex-grow-1 mb-3 border rounded"
            style="background: #fff; display: flex; flex-direction: column; min-height: 0; overflow: hidden;">
            <div id="editor" style="flex: 1; border: none;">
              {% if job_description_html %} {{ job_description_html|safe }} {%
              endif %}
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100 py-2 fw-medium">
            Analyze Match
          </button>
        </form>
      </div>
    </div>
  </div>
  <style>
    /* Custom CSS to make Quill editor scrollable within the flex container */
    .ql-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden !important;
      height: 100%;
    }

    .ql-editor {
      flex: 1;
      overflow-y: auto !important;
    }
  </style>

  <!-- Right Column: Resume Preview -->
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0 fw-bold">Candidate Resume</h5>
        <a href="{{ url_for('download_resume', resume_id=resume.id) }}" class="btn btn-sm btn-outline-secondary">
          Download PDF
        </a>
      </div>
      <div class="card-body p-0 bg-light" style="height: 600px;">
        {% if can_preview_pdf and viewer_url %}
        <iframe src="{{ viewer_url }}" style="width: 100%; height: 100%; border: none;"></iframe>
        {% else %}
        <div class="d-flex flex-column align-items-center justify-content-center h-100 p-5 text-center text-muted">
          <p class="mb-3">Preview not available for this file type.</p>
          <a href="{{ url_for('download_resume', resume_id=resume.id) }}" class="btn btn-primary">
            Download File
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Bottom Row: Analysis Results (Conditional) -->
{% if analysis_results %}
<div class="row">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-bottom py-0">
        <ul class="nav nav-underline card-header-tabs" id="analysisTabs" role="tablist" style="margin-bottom: -1px;">
          <li class="nav-item" role="presentation">
            <button class="nav-link active text-dark fw-semibold py-3 px-4" id="analysis-tab" data-bs-toggle="tab"
              data-bs-target="#analysis-pane" type="button" role="tab" aria-controls="analysis-pane"
              aria-selected="true" style="border-radius: 0;">Analysis</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link text-secondary fw-semibold py-3 px-4" id="resume-tab" data-bs-toggle="tab"
              data-bs-target="#resume-pane" type="button" role="tab" aria-controls="resume-pane" aria-selected="false"
              style="border-radius: 0;">Revised Resume</button>
          </li>
        </ul>
      </div>
      <div class="card-body p-4">
        <div class="tab-content" id="analysisTabsContent">
          <!-- Analysis Tab -->
          <div class="tab-pane fade show active" id="analysis-pane" role="tabpanel" aria-labelledby="analysis-tab">
            <div class="row align-items-center">
              <!-- Score Section -->
              <div class="col-md-3 text-center border-end">
                <h6 class="text-secondary text-uppercase small fw-bold mb-3 tracking-wide">
                  Match Score
                </h6>
                <div class="position-relative d-inline-flex align-items-center justify-content-center">
                  <svg viewBox="0 0 36 36" class="circular-chart" style="width: 140px; height: 140px;">
                    <path class="circle-bg"
                      d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                      style="fill: none; stroke: #f1f3f4; stroke-width: 2.5;" />
                    <path class="circle" stroke-dasharray="{{ analysis_results.score }}, 100"
                      d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                      style="fill: none; stroke: {% if analysis_results.score >= 80 %}#198754{% elif analysis_results.score >= 50 %}#ffc107{% else %}#dc3545{% endif %}; stroke-width: 2.5; stroke-linecap: round; animation: progress 1s ease-out forwards;" />
                  </svg>
                  <div class="position-absolute d-flex flex-column align-items-center">
                    <span class="fw-bold display-6 text-dark mb-0">{{ analysis_results.score }}%</span>
                    <span class="small text-muted">Match</span>
                  </div>
                </div>
              </div>

              <!-- Details Section -->
              <div class="col-md-9 ps-md-4">
                <div class="mb-4">
                  <h6 class="text-muted text-uppercase small fw-bold mb-2">
                    Summary
                  </h6>
                  <p class="text-secondary lead fs-6">
                    {{ analysis_results.summary }}
                  </p>
                </div>

                <div class="row g-4">
                  <!-- Keywords Column -->
                  <div class="col-md-6">
                    <div class="mb-3">
                      <h6 class="text-muted text-uppercase small fw-bold mb-2">
                        Matching Keywords
                      </h6>
                      <div class="d-flex flex-wrap gap-1">
                        {% for keyword in analysis_results.matching_keywords %}
                        <span
                          class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">{{
                          keyword }}</span>
                        {% endfor %}
                      </div>
                    </div>
                    <div>
                      <h6 class="text-muted text-uppercase small fw-bold mb-2">
                        Missing Keywords
                      </h6>
                      <div class="d-flex flex-wrap gap-1">
                        {% for keyword in analysis_results.missing_keywords %}
                        <span
                          class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25">{{
                          keyword }}</span>
                        {% endfor %}
                      </div>
                    </div>
                  </div>

                  <!-- Recommendations Column -->
                  <div class="col-md-6">
                    <h6 class="text-muted text-uppercase small fw-bold mb-2">
                      Recommendations
                    </h6>
                    <ul class="list-group list-group-flush small">
                      {% for rec in analysis_results.recommendations %}
                      <li class="list-group-item px-0 py-1 border-0 d-flex gap-2">
                        <span class="text-warning">&bull;</span>
                        <span>{{ rec }}</span>
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Revised Resume Tab -->
          <div class="tab-pane fade" id="resume-pane" role="tabpanel" aria-labelledby="resume-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="text-secondary text-uppercase small fw-bold mb-0 tracking-wide">AI Generated Resume Draft
              </h6>
              <button class="btn btn-sm btn-outline-primary"
                onclick="navigator.clipboard.writeText(document.getElementById('revised-content-hidden').innerText); alert('Copied to clipboard!');">
                Copy to Clipboard
              </button>
            </div>

            <!-- Hidden element for raw text copying -->
            <div id="revised-content-hidden" style="display: none;">{{ analysis_results['Updated resume'] if 'Updated
              resume' in analysis_results else '' }}</div>

            <div class="bg-light p-3 rounded border">
              <div class="bg-white shadow-sm p-5 mx-auto"
                style="max-width: 800px; min-height: 800px; font-family: 'Times New Roman', serif; color: #000; line-height: 1.6;">
                {% if 'Updated resume' in analysis_results %}
                {{ analysis_results['Updated resume'] | markdown | safe }}
                {% else %}
                <p class="text-muted text-center">No revised resume available.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var toolbarOptions = [
      [{ header: [1, 2, 3, false] }],
      ["bold", "italic", "underline"],
      [{ list: "ordered" }, { list: "bullet" }],
      ["clean"],
    ];

    var editor = new Quill("#editor", {
      theme: "snow",
      modules: {
        toolbar: toolbarOptions,
      },
      placeholder: "Paste job description here...",
    });

    var form = document.querySelector("#compare-form");
    var hiddenInput = document.getElementById("job_description_input");

    form.addEventListener("submit", function () {
      hiddenInput.value = editor.root.innerHTML;
    });

    // Job Loading Logic
    document.querySelectorAll('.load-job-btn').forEach(item => {
      item.addEventListener('click', event => {
        event.preventDefault(); // Prevent default anchor behavior
        // const description = item.getAttribute('data-description'); // This might be HTML encoded
        // To safely decode HTML entities if passed via data attribute:
        const description = new DOMParser().parseFromString(item.getAttribute('data-description'), "text/html").documentElement.textContent;

        // However, a safer way is to fetch via AJAX if description is large, 
        // but for now, let's assume it's passed safely or use the textarea trick
        editor.root.innerHTML = description;
      })
    });
  });
</script>
{% endblock %}