{% extends "layouts/base_app.html" %}

{% block title %}Compare Resume{% endblock %}

{% block content %}
<!-- Toolbar / Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <a href="{{ url_for('dashboard.dashboard') }}"
      class="text-decoration-none text-muted mb-2 d-inline-block fw-medium small">
      <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
    </a>
    <h2 class="h3 fw-bold text-dark mb-0">Match Analyzer</h2>
    <p class="text-secondary mb-0">Optimize your resume for a specific job description.</p>
  </div>
</div>

<!-- Top Row: Inputs -->
<div class="row g-4 mb-5">
  <!-- Left Column: Job Description Input -->
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
        <h6 class="card-title mb-0 fw-bold text-uppercase small tracking-wide">1. Target Job</h6>
        <!-- Load Job Dropdown -->
        <div class="dropdown">
          <button class="btn btn-sm btn-white border dropdown-toggle" type="button" data-bs-toggle="dropdown"
            aria-expanded="false">
            <i class="bi bi-download me-1"></i> Load Saved
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0" style="max-height: 300px; overflow-y: auto;">
            {% if jobs %}
            {% for job in jobs %}
            <li><a class="dropdown-item load-job-btn small" href="#" data-description="{{ job.description | e }}">{{
                job.title
                }}</a></li>
            {% endfor %}
            {% else %}
            <li><span class="dropdown-item text-muted small">No saved jobs</span></li>
            {% endif %}
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item text-primary small fw-bold" href="{{ url_for('jobs.jobs_create') }}">+ Create
                New
                Job</a></li>
          </ul>
        </div>
      </div>
      <div class="card-body d-flex flex-column" style="height: 500px;">
        <form method="post" id="compare-form" class="d-flex flex-column flex-grow-1" style="min-height: 0;">
          <input type="hidden" name="job_description" id="job_description_input" />

          <div class="flex-grow-1 mb-3 border rounded-3 overflow-hidden position-relative">
            <div id="editor" class="h-100 border-0">
              {% if job_description_html %} {{ job_description_html|safe }} {% endif %}
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">
            <i class="bi bi-magic me-2"></i>Analyze Match
          </button>
        </form>
      </div>
    </div>
  </div>
  <style>
    .ql-container {
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
    }

    .ql-toolbar {
      border-top: 0 !important;
      border-left: 0 !important;
      border-right: 0 !important;
      border-bottom: 1px solid #e2e8f0 !important;
      background: #f8fafc;
    }

    .ql-container.ql-snow {
      border: none !important;
    }
  </style>

  <!-- Right Column: Resume Preview -->
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
        <h6 class="card-title mb-0 fw-bold text-uppercase small tracking-wide">2. Your Resume</h6>
        <div class="d-flex gap-2">
          <span class="badge bg-light text-dark border">{{ resume.name }}</span>
          <a href="{{ url_for('resumes.download_resume', resume_id=resume.id) }}" class="btn btn-sm btn-light border"
            title="Download Original">
            <i class="bi bi-download"></i>
          </a>
        </div>
      </div>
      <div class="card-body p-0 bg-light position-relative overflow-hidden" style="height: 500px;">
        {% if can_preview_pdf and viewer_url %}
        <iframe src="{{ viewer_url }}" style="width: 100%; height: 100%; border: none;"></iframe>
        {% else %}
        <div class="d-flex flex-column align-items-center justify-content-center h-100 p-5 text-center">
          <div class="bg-white p-4 rounded-circle shadow-sm mb-3">
            <i class="bi bi-file-earmark-text display-4 text-secondary"></i>
          </div>
          <p class="text-muted fw-medium">Preview not available.</p>
          <a href="{{ url_for('resumes.download_resume', resume_id=resume.id) }}"
            class="btn btn-outline-primary btn-sm">
            Download File to View
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Bottom Row: Analysis Results (Conditional) -->
{% if analysis_results %}
<div class="row" id="results">
  <div class="col-12">
    <div class="card border-0 shadow-lg overflow-hidden">
      <div class="card-header bg-white border-bottom px-4 py-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="fw-bold mb-0 text-primary">Analysis Results</h5>
          <ul class="nav nav-pills card-header-pills" id="analysisTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active rounded-pill px-4" id="analysis-tab" data-bs-toggle="tab"
                data-bs-target="#analysis-pane" type="button" role="tab">Overview & Actions</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link rounded-pill px-4" id="resume-tab" data-bs-toggle="tab"
                data-bs-target="#resume-pane" type="button" role="tab">AI Optimized Resume</button>
            </li>
          </ul>
        </div>
      </div>

      <div class="card-body p-0">
        <div class="tab-content" id="analysisTabsContent">
          <!-- Analysis Tab -->
          <div class="tab-pane fade show active" id="analysis-pane" role="tabpanel">
            <div class="p-4 p-md-5">
              <div class="row align-items-start g-5">
                <!-- Score Section -->
                <div class="col-md-3 text-center">
                  <div class="card bg-light border-0 rounded-4 p-4">
                    <h6 class="text-secondary text-uppercase small fw-bold mb-3 tracking-wide">ATS Match Score</h6>

                    <div class="position-relative d-inline-flex align-items-center justify-content-center mb-3">
                      {% set stroke = '#ef4444' %}
                      {% if analysis_results.score >= 80 %}
                      {% set stroke = '#22c55e' %}
                      {% elif analysis_results.score >= 50 %}
                      {% set stroke = '#eab308' %}
                      {% endif %}
                      <svg viewBox="0 0 36 36" class="circular-chart" style="width: 160px; height: 160px;">
                        <path class="circle-bg"
                          d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          style="fill: none; stroke: #e2e8f0; stroke-width: 2.5;" />
                        <path class="circle" stroke-dasharray="{{ analysis_results.score }}, 100"
                          d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          style="fill: none; stroke: {{ stroke }}; stroke-width: 2.5; stroke-linecap: round; animation: progress 1s ease-out forwards;" />
                      </svg>
                      <div class="position-absolute d-flex flex-column align-items-center">
                        <span class="fw-bold display-4 text-dark mb-0">{{ analysis_results.score }}</span>
                        <span class="small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">out of
                          100</span>
                      </div>
                    </div>

                    <div class="d-grid">
                      <button class="btn btn-primary btn-sm rounded-pill fw-bold"
                        onclick="document.getElementById('resume-tab').click()">
                        View Fixes &rarr;
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Details Section -->
                <div class="col-md-9">
                  <div class="mb-5">
                    <h5 class="fw-bold text-dark mb-2">Executive Summary</h5>
                    <p class="text-secondary fs-5" style="line-height: 1.6;">
                      {{ analysis_results.summary }}
                    </p>
                  </div>

                  <div class="row g-4">
                    <!-- Keywords -->
                    <div class="col-md-6">
                      <div class="card border border-success border-opacity-25 bg-success bg-opacity-10 h-100">
                        <div class="card-body">
                          <div class="d-flex align-items-center mb-3 text-success">
                            <i class="bi bi-check-circle-fill me-2 fs-5"></i>
                            <h6 class="fw-bold mb-0 text-uppercase small">Matching Keywords</h6>
                          </div>
                          <div class="d-flex flex-wrap gap-2">
                            {% for keyword in analysis_results.matching_keywords %}
                            <span
                              class="badge bg-white text-success border border-success border-opacity-25 fw-medium py-2 px-3">
                              {{ keyword }}
                            </span>
                            {% endfor %}
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="card border border-danger border-opacity-25 bg-danger bg-opacity-10 h-100">
                        <div class="card-body">
                          <div class="d-flex align-items-center mb-3 text-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                            <h6 class="fw-bold mb-0 text-uppercase small">Critical Missing Keywords</h6>
                          </div>
                          <div class="d-flex flex-wrap gap-2">
                            {% for keyword in analysis_results.missing_keywords %}
                            <span
                              class="badge bg-white text-danger border border-danger border-opacity-25 fw-medium py-2 px-3">
                              {{ keyword }}
                            </span>
                            {% endfor %}
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Recommendations -->
                    <div class="col-12">
                      <div class="card border bg-white mt-2">
                        <div class="card-header bg-white py-3">
                          <h6 class="fw-bold mb-0 text-dark">Action Plan & Recommendations</h6>
                        </div>
                        <ul class="list-group list-group-flush">
                          {% for rec in analysis_results.recommendations %}
                          <li class="list-group-item px-4 py-3 d-flex gap-3 align-items-start">
                            <div class="bg-warning bg-opacity-10 text-warning rounded-circle p-1 mt-1 flex-shrink-0">
                              <i class="bi bi-lightbulb-fill"></i>
                            </div>
                            <span class="text-secondary">{{ rec }}</span>
                          </li>
                          {% endfor %}
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Revised Resume Tab -->
          <div class="tab-pane fade" id="resume-pane" role="tabpanel">
            <div class="bg-light border-bottom px-4 py-3 d-flex justify-content-between align-items-center sticky-top">
              <div>
                <h6 class="fw-bold text-dark mb-0">AI Optimization Preview</h6>
                <small class="text-muted">Generated based on analysis results</small>
              </div>
              <button class="btn btn-primary btn-sm shadow-sm"
                onclick="navigator.clipboard.writeText(document.getElementById('revised-content-hidden').innerText); alert('Copied markdown to clipboard!');">
                <i class="bi bi-clipboard me-1"></i> Copy Markdown
              </button>
            </div>

            <!-- Hidden element for raw text copying -->
            <div id="revised-content-hidden" style="display: none;">{{ analysis_results['updated_resume_markdown'] if
              'updated_resume_markdown' in analysis_results else '' }}</div>

            <div class="bg-light p-4 p-md-5">
              <div class="bg-white shadow-sm p-5 mx-auto rounded-3"
                style="max-width: 850px; min-height: 1000px; font-family: 'Times New Roman', serif; color: #1e293b; line-height: 1.6;">
                {% if 'updated_resume_markdown' in analysis_results %}
                {{ analysis_results['updated_resume_markdown'] | markdown | safe }}
                {% else %}
                <div class="text-center py-5">
                  <p class="text-muted mb-0">No revised resume available.</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}
</div>

<link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var toolbarOptions = [
      [{ header: [1, 2, 3, false] }],
      ["bold", "italic", "underline"],
      [{ list: "ordered" }, { list: "bullet" }],
      ["clean"],
    ];

    var editor = new Quill("#editor", {
      theme: "snow",
      modules: {
        toolbar: toolbarOptions,
      },
      placeholder: "Paste job description here...",
    });

    var form = document.querySelector("#compare-form");
    var hiddenInput = document.getElementById("job_description_input");

    form.addEventListener("submit", function () {
      hiddenInput.value = editor.root.innerHTML;
    });

    // Job Loading Logic
    document.querySelectorAll('.load-job-btn').forEach(item => {
      item.addEventListener('click', event => {
        event.preventDefault(); // Prevent default anchor behavior
        // const description = item.getAttribute('data-description'); // This might be HTML encoded
        // To safely decode HTML entities if passed via data attribute:
        const description = new DOMParser().parseFromString(item.getAttribute('data-description'), "text/html").documentElement.textContent;

        // However, a safer way is to fetch via AJAX if description is large, 
        // but for now, let's assume it's passed safely or use the textarea trick
        editor.root.innerHTML = description;
      })
    });
  });
</script>
{% endblock %}